<!doctype html>
<html>
<head>
<title>CarShop</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css?family=Titillium+Web:300" rel="stylesheet">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<style>

*:not(button, select, input) {
    margin: 0;
    padding: 0;
    border: 0;
    outline: 0;
    font-size: 100%;
    vertical-align: baseline;
    background: transparent;
    font-size: 1em;
    font-family: 'Titillium Web', sans-serif;
}

a {
    color: black;
    text-decoration:none;
}

hr {
    border: 0;
    clear:both;
    display:block;
    text-align: center;
    margin-left: auto;
    margin-right: auto;
    width: inherit;
    background-color: black;
    height: 1px;
}

#view {
    width: 100vw;
}

#header {
    background: linear-gradient(141deg, #0fb8ad 0%, #1fc8db 51%, #2cb5e8 75%);
    font-family: 'Titillium Web', sans-serif;
    text-align: center;
    color: white;
    margin: 0;
    width: 80vw;
    padding-left: 10vw;
    padding-right: 10vw;
}

#header img {
    width: 15em;
    padding: 1em;
}

#title {
    font-size: 3.5em;
    color: white;
    letter-spacing: 1em;
}

#navbar {
    display: inline-block;
}

#navbar a {
    font-size: 2em;
    color: rgb(255,255,255);
}

#navbar a:hover {
    color: rgb(230,230,230);
}

#view #title {
    font-family: 'Titillium Web', sans-serif;
    text-align: center;
    font-size: 5em;
}

#filter {
    display: inline-block;
    text-align: center;
    width: 100vw;
    padding-top: 10px;
    padding-bottom: 10px;
    margin-bottom: 20px;
}

#filterbar p {
    display: inline-block;
    padding-right: 10px;
}

#filtermakemodel {
    display: block;
}

#filteryear {
    display: block;
}

/*Overviews*/
#content p {
    font-family: 'Titillium Web', sans-serif;
    text-align: center;
    font-size: 2em;
}

#content table {
    width: 80vw;
    margin-left: auto;
    margin-right: auto;
    table-layout: fixed;
    display: block;
}

#content td {
    padding: 15px;
    border: 1px solid rgb(230,230,230);
    border-collapse: collapse;
    display: inline-block;
    text-align: center;
    overflow: hidden;
}

#content td, img {
    width: 17.5vw;
}


/*Details*/
#content #image {
    width: 50vw;
    display: inline-block;
}

#content #details {
    width: 45vw;
    margin-left: 3vw;
    display: inline-block;
}

#details #title {
    font-size: 3.5em;
    color: black;
    letter-spacing: 0.6em;
}

#details #subtitle {
    font-size: 2em;
    color: black;
}

#details #price {
    color: white;
    font-size: 3em;
    letter-spacing: 0.6em;
    background: linear-gradient(141deg, #0fb8ad 0%, #1fc8db 51%, #2cb5e8 75%);
    border-radius: 20px;
    min-width: 500px;
}

#details ul {
    margin-left: auto;
    margin-right: auto;
    list-style-type: circle;
    padding-top: 10px;
    padding-bottom: 20px;
}

/*Login*/
#login {
    width: 30vw;
    min-width: 500px;
    margin-left: auto;
    margin-right: auto;
    text-align: center;
    color: black;
}

#login #title {
    color: black;
}

#login form {
    margin-left: auto;
    margin-right: auto;
    text-align: center;
}

@media screen and (max-width: 1060px) {
    #title {
        font-size: 1.5em;
    }

    #navbar a {
        font-size: 1em;
    }
}

@media screen and (max-width: 700px) {
    #title {
        font-size: 1em;
    }

    .subject .title {
        font-size: 1.5em;
    }

    #navbar a {
        font-size: 1em;
    }

    #content #image, #content #details {
        min-width: 300px;
    }

    #content #image {
        width: 90vw;
        margin-left: auto;
        margin-right: auto;
    }

    #content #details {
        width: 90vw;
        padding-left: 25px;
    }

    #details #title {
        font-size: 2em;
    }

    #details #price {
        font-size: 1.5em;
    }
}

</style>

<head>
<body>

<div id="header">
    <a onclick="initial()">
    <img src="icons/Logo.svg">
    <p id="title">CarShop</p></a>
    <div id="navbar">
        <a onclick="initial()">CARS -</a>
        <a onclick="setLoginView()">MY PROFILE -</a>
        <a href="#">CONTACT -</a>
        <a href="#">ABOUT US</a>
    </div>
</div>

<div id="view">
<div id="filter">
    <button type="button" onclick="showFilters()">Filter</button>
    <div id="filterbar">
        <p>Filter</p>
        <hr/>
        <div id="filtermakemodel">
            <p>Make & Model</p>
            <select class="selector" id="selectmake">
                <option value="" disabled="disabled" selected="selected">Brand</option>
            </select>
            <select class="selector" id="selectmodel">
                <option value="" disabled="disabled" selected="selected">Model</option>
            </select>
        </div>
        <div id="filteryear">
        <p>Year</p>
            <select class="selector" id="selectyear">
                <option value="" disabled="disabled" selected="selected">Year</option>
            </select>
        </div>
    </div>
</div>

<div id="content">
    <p>Over 7000 Cars For Sale<p>
</div>
</div>

</body>
</html>


<script>
    var ip = '145.24.222.132'; //change this to use a localhost
    var port = '8080';

    function uArray(array) {
        return array.filter(function(itm,i,array) {
            return i==array.indexOf(itm);
        });
    } //Returns an array with only unique values

    function toUpperCaseFirst(string) {
        string = string.toLowerCase().replace(/\b[a-z]/g, function(letter) {
            return letter.toUpperCase();
        });
        return string;
    } //Makes the first letter of the string upper-cased

    function setFilters() {
        $('#filter').hide();
        $.get('http://' + ip + ':' + port + '/filter/Car/model/nn', function(data){
            var brandarray = [];
            var modelarray = [];
            var yeararray = [];

            brandarray.push('<option value="" disabled="disabled" selected="selected">Brand</option>');
            modelarray.push('<option value="" disabled="disabled" selected="selected">Model</option>');
            yeararray.push('<option value="" disabled="disabled" selected="selected">Year</option>');

            for (var i = data.length - 1; i >= 0; i--) {
                brandarray.push('<option value="">' + data[i].properties.make + '</option>');
                modelarray.push('<option value="">' + data[i].properties.model + '</option>');
                yeararray.push('<option value="">' + data[i].properties.year + '</option>');
            }

            brandarray = uArray(brandarray);
            modelarray = uArray(modelarray);
            yeararray = uArray(yeararray);

            $('#selectbrand').html(brandarray.join(''));
            $('#selectmodel').html(modelarray.join(''));
            $('#selectyear').html(yeararray.join(''));

            $('#filter').show();
        });
    }

    function setFilter(property, extra) {
        var string = property;
        if(extra != undefined) {
            string = string + extra;
        }

        $.get('http://' + ip + ':' + port + '/filter/Car?property1=' + string, function(data){
            console.log(property);
            var array = [];
            array.push('<option value="" disabled="disabled" selected="selected">' + toUpperCaseFirst(property) + '</option>');

            for (var i = data.length - 1; i >= 0; i--) {
                array.push('<option value="">' + data[i] + '</option>');
            }

            array = uArray(array);
            $('#select' + property).html(array.join(''));
        });
    }

    function showKey(string) {
        string = string.split('_');
        var result = '';
        for (i = 0; i < string.length; i++) {
            if(i != 0) {
                result = result + toUpperCaseFirst(string[i]) + ' ';
            }
        }
        return result;
    }

    function setLoginView() {
        var url = 'http://' + ip + ':' + port + '/views/login.html';
        $.get(url, function(data) {
            $('#filter').hide();
            $('#content').html(data);
        });

        $('#')
//        var url = 'http://145.24.222.132:8080/login/attempt&user=' + user + '&password=' + password;
//        $.post(url, function(data) {
//            $('#view').html('<p id="title">' + data + '</p>');
//        });
    }

    function setProfileView(value) {

    }

    function setDetailView(value) {
        $('#filter').show();
        var url = 'http://' + ip + ':' + port + '/detail/' + value;

        $.get(url, function(data) {
            var image = '<img id="image" src="http://www.pngpix.com/wp-content/uploads/2016/02/BMW-Car-PNG-image-1.png">';
            var details = $('<div id="details"></div>');
            var title = '<p id="title">' + data[0].properties.make + " " + data[0].properties.model + '</p>';
            var subtitle = '<p id="subtitle">' + data[0].properties.year + '</p><hr><br>';
            var price = '<p id="price">&euro;' + data[0].properties.price + '</p>';

            var blacklist = ['model_sold_in_us', 'model', 'make', 'year', 'make_display', 'price', 'model_year', 'model_make_display', 'model_make_id', 'model_trim', 'model_name'];

            var list = $('<ul></ul>');
            for (var key in data[0].properties) {
                if (data[0].properties.hasOwnProperty(key)) {
                    if(data[0].properties[key] != 'null' && data[0].properties[key] != '' && $.inArray(key, blacklist) == -1) {
                        list.append('<li>' + showKey(key) + ': ' + data[0].properties[key] + '</li>');
                    }
                }
            }

            details.append(title);
            details.append(subtitle);
            details.append(price);
            details.append(list);

            $('#content').html('');
            $('#content').append(image);
            $('#content').append(details);
        });
    }

    function setJSONTable(value) {
        $('#filter').show();
        var url = 'http://' + ip + ':' + port + value;
        console.log(value);
        $.get(url, function(data) {
            var table = $('<table>');

            var row = $('<tr>');
            for (var i = data.length - 1; i >= 0; i--) {
                var itemcontainer = $('<a onclick="setDetailView(' + data[i]._id + ')"></a>');
                var item = $('<td></td>');

                // item.append("<img src=\"" + data[i].properties.picture + "\">");
                item.append(data[i].properties.make);
                item.append(" " + data[i].properties.model);
                item.append(" " + data[i].properties.year);
                item.append("<br>&euro;" + data[i].properties.price);

                itemcontainer.append(item);
                row.append(itemcontainer);
            }

            row.append('</tr>');
            table.append(row);
            table.append('</table>');
            $('#content').html('');
            $('#content').append(table);
        });
    }

    function addListeners(value) {
        var property = false;
        $("#select" + value).hover(function () {
            if(!property) {
                setFilter(value);
                property = true;
            }
        });

        $("#select" + value).change(function () {
            if(value == 'make') {
                setFilter('model', '&extraprop=make&extraval=' + $('#selectmake option:selected').text());
                $('#selectmodel').show();
                $('#selectmodel').prop('selectedIndex',0);
                setJSONTable('/filter/Car?property1=' + value + '&value1=' + $('#selectmake option:selected').text());
            } else if(value == 'model') {
                setJSONTable('/filter/Car?property1=make&value1=' + $('#selectmake option:selected').text() + '&property2=' + value + '&value2=' + $('#selectmodel option:selected').text());
            } else {
                $('#selectmodel').prop('selectedIndex',0);
                $('#selectmodel').hide();
                $('#selectmake').prop('selectedIndex',0);
                setJSONTable('/filter/Car?property1=' + value + '&value1=' + $('#select' + value + ' option:selected').text());
            }
        });
    }

    function showFilters() {
        if($('#filterbar').css('display') == 'none') {
            setFilter('make');
            setFilter('year');
            $('#filterbar').show();
        } else {
            $('#filterbar').hide();
        }
    }

    function initial() {
        //Initial Setup
        setJSONTable('/filter/Car');
    }

    $('#filterbar').hide();
    $('#selectmodel').hide();
    addListeners('make');
    addListeners('model');
    addListeners('year');

    initial();

</script>